<div class="space-y-6 animate-in fade-in duration-500">
  <header class="flex justify-between items-end">
    <div class="flex-1 mr-4">
      <h2 class="text-2xl font-bold text-white mb-2">Historial d'Escanejos</h2>
      <p class="text-slate-400">
        Registre complet de totes les auditories de seguretat realitzades.
      </p>
    </div>
    <div class="flex gap-2 items-center">
      <!-- Search Bar -->
      <div class="relative">
        <div
          class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.3-4.3" />
          </svg>
        </div>
        <input
          type="text"
          placeholder="Cercar..."
          [value]="searchQuery()"
          (input)="updateSearch($event)"
          class="bg-slate-900 border border-slate-700 text-white text-sm rounded-lg pl-9 pr-4 py-2 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none w-48 transition-all focus:w-64"
        />
      </div>

      <button
        (click)="refreshList()"
        [disabled]="isRefreshing()"
        class="px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-300 hover:text-white hover:border-slate-600 transition-colors flex items-center gap-2"
      >
        <svg
          [class.animate-spin]="isRefreshing()"
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
          <path d="M3 3v5h5" />
          <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" />
          <path d="M16 21h5v-5" />
        </svg>
        Actualitzar
      </button>

      <button
        class="px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-300 hover:text-white hover:border-slate-600 transition-colors flex items-center gap-2"
        (click)="exportToCsv()"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="7 10 12 15 17 10" />
          <line x1="12" x2="12" y1="15" y2="3" />
        </svg>
        Exportar
      </button>
    </div>
  </header>

  <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
    <table class="w-full text-left text-sm">
      <thead
        class="bg-slate-950 text-slate-500 uppercase text-xs border-b border-slate-800 select-none"
      >
        <tr>
          <th
            (click)="toggleSort('status')"
            class="px-6 py-4 cursor-pointer hover:text-white transition-colors group"
          >
            Estat
            <span
              class="ml-1 inline-block transition-transform"
              [class]="getSortIconClass('status')"
              >↓</span
            >
          </th>
          <th
            (click)="toggleSort('target')"
            class="px-6 py-4 cursor-pointer hover:text-white transition-colors group"
          >
            Objectiu
            <span
              class="ml-1 inline-block transition-transform"
              [class]="getSortIconClass('target')"
              >↓</span
            >
          </th>
          <th
            (click)="toggleSort('scanType')"
            class="px-6 py-4 cursor-pointer hover:text-white transition-colors group"
          >
            Tipus d'escaneig
            <span
              class="ml-1 inline-block transition-transform"
              [class]="getSortIconClass('scanType')"
              >↓</span
            >
          </th>
          <th
            (click)="toggleSort('date')"
            class="px-6 py-4 cursor-pointer hover:text-white transition-colors group"
          >
            Data
            <span class="ml-1 inline-block transition-transform" [class]="getSortIconClass('date')"
              >↓</span
            >
          </th>
          <th
            (click)="toggleSort('findings')"
            class="px-6 py-4 cursor-pointer hover:text-white transition-colors group"
          >
            Vulnerabilitats
            <span
              class="ml-1 inline-block transition-transform"
              [class]="getSortIconClass('findings')"
              >↓</span
            >
          </th>
          <th
            (click)="toggleSort('duration')"
            class="px-6 py-4 cursor-pointer hover:text-white transition-colors group"
          >
            Durada
            <span
              class="ml-1 inline-block transition-transform"
              [class]="getSortIconClass('duration')"
              >↓</span
            >
          </th>
          <th class="px-6 py-4 text-right">Accions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-800">
        @for (scan of filteredHistory(); track scan.id) {
        <tr class="hover:bg-slate-800/50 group transition-colors">
          <td class="px-6 py-4">
            <span
              class="px-3 py-1 rounded-md text-xs font-bold uppercase tracking-wide"
              [class]="getHistoryStatusClass(scan.state)"
              >{{ scan.state }}</span
            >
          </td>
          <td class="px-6 py-4">
            <div class="font-medium text-white font-mono">{{ scan.target }}</div>
            <div class="text-xs text-slate-500 mt-0.5">ID: #SCAN-{{ scan.id }}</div>
          </td>
          <td class="px-6 py-4 text-slate-400">{{ scan.scanType }}</td>
          <td class="px-6 py-4 text-slate-400">{{ scan.date }}</td>
          <td class="px-6 py-4">
            @if (scan.state === 'RUNNING') {
            <span class="text-blue-400 animate-pulse">Analitzant...</span> } @else if
            (scan.vulnerabilityCount > 0) {
            <span class="text-red-400 font-medium">{{ scan.vulnerabilityCount }} detectades</span> }
            @else { <span class="text-slate-500">Cap incidència</span> }
          </td>
          <td class="px-6 py-4 text-slate-500 font-mono text-xs">
            @if (scan.status === 'RUNNING') { -- } @else { {{ scan.duration }} }
          </td>
          <td class="px-6 py-4 text-right">
            <button
              (click)="viewReport(scan)"
              [disabled]="scan.state === 'RUNNING'"
              [class]="
                scan.state === 'RUNNING'
                  ? 'opacity-50 cursor-not-allowed'
                  : 'hover:bg-slate-700 hover:text-emerald-300'
              "
              class="text-xs bg-slate-800 text-emerald-400 px-3 py-1.5 rounded border border-slate-700 transition-colors"
            >
              Veure Informe
            </button>
          </td>
        </tr>
        } @if (filteredHistory().length === 0) {
        <tr>
          <td colspan="6" class="px-6 py-8 text-center text-slate-500 italic">
            No s'han trobat resultats per "{{ searchQuery() }}"
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  @if(isReportShown() === true) {

  <app-report
    [(isReportShown)]="isReportShown"
    [(selectedReport)]="selectedReport"
    [(reportResults)]="reportResults"
  />

  }
</div>
